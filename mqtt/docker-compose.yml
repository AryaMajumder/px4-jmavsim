version: "3.8"

services:
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: mosquitto
    restart: unless-stopped

    # Security: bind only to localhost on the cloud VM
    ports:
      - "127.0.0.1:1883:1883"

    volumes:
      - ./config/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - ./config/passwords:/mosquitto/config/passwords:ro
      - ./config/acl:/mosquitto/config/acl:ro
      - ./data:/mosquitto/data
      - ./log:/mosquitto/log

    healthcheck:
      test: ["CMD", "mosquitto_sub", "-h", "localhost", "-p", "1883", "-u", "drone", "-P", "dronepass", "-t", "test/health", "-C", "1", "-W", "5"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 5s
